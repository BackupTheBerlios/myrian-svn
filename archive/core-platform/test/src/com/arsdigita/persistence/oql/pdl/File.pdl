// Copyright (C) 2001 ArsDigita Corporation. All Rights Reserved.
//
// The contents of this file are subject to the ArsDigita Public 
// License (the "License"); you may not use this file except in
// compliance with the License. You may obtain a copy of
// the License at http://www.arsdigita.com/ADPL.txt
//
// Software distributed under the License is distributed on an "AS
// IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
// implied. See the License for the specific language governing
// rights and limitations under the License.
//

model test;

import com.arsdigita.kernel.*;

// Note that content retrieval and insert are factored out as separate
// events to speed up loading the meta-data only.

object type File extends ResourceImpl {
    String mimeType = docs_resources.mime_type VARCHAR(200);
    Blob content = docs_resources.content BLOB;
    BigDecimal size = docs_files.length INTEGER;

    reference key (docs_files.file_id);

    insert {
        super;

        do {
            update docs_resources
            set mime_type = :mimeType,
                content = :content
            where resource_id = :id
        } map {
            content: BLOB;
        }
    }

    update {
        super;

        do {
            update docs_resources
            set mime_type = :mimeType,
                content = :content
            where resource_id = :id
        } map {
            content: BLOB;
        }
    }

}

query getFileRevisionBlob {
  do  {
       select new_value 
        from  vc_blob_operations 
        where operation_id = (select operation_id 
                                from vc_operations 
                                where transaction_id = :transactionID
                                and attribute = 'content'
                                and action in ('create','update'))
   } map {
        content = new_value;
   }     
}